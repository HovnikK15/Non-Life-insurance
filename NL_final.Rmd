---
title: "Non-Life Insurance - Final project"
output: html_document
author: "Klemen Hovnik and Manca Strgar"
---

```{r setup, include=FALSE, warning=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r packages,  include=FALSE, warning = FALSE, message = FALSE}
#package instalation:
packages <- c("tidyverse", "mgcv", "evtree", "classInt", "rgdal", "RColorBrewer", "grid", "gridExtra", "visreg", "sf", "tmap", "rgeos", "mapview", "leaflet", "rmarkdown", "ggplot2")
suppressMessages(packages <- lapply(packages, FUN = function(x) {
  if (!require(x, character.only = TRUE)) {
    install.packages(x)
    library(x, character.only = TRUE)
  }
  else {
  message("Everything is set up correctly. You are ready to go.")
}
}))

#libraries:
library(dplyr)
library(knitr)
library(rmarkdown)
library(tidyverse)
library(ggplot2)
library(graphics)
library(here)
library(gridExtra)
library(mgcv)
library(evtree)
library(classInt)
library(rgdal)
library(RColorBrewer)
library(grid)
library(visreg)
library(sf)
library(tmap)
library(rgeos)
library(mapview)
library(leaflet)

```
PART 1
=======

# 1 Importing dataset

First, we need to import data from the file `Assignment.csv` into R. The file contains 163.657 rows with 16 variables. The column `nbrtotc` shows total number of claims during the period of exposure. 
Let's have a look at our dataset:

```{r, echo=F}
mtpl_orig <- read.csv("Assignment.csv", header = TRUE)
mtpl_orig=as_tibble(mtpl_orig)
kable(head(mtpl_orig))
#str(mtpl_orig)
#summary(mtpl_orig)

```

We could rename colums in our dataset to make it easier to work with. We will rename the column `nbrtotc` into `nclaims` as the number of claims, and `duree` into `expo` as exposure. For easier programming we will also rename `ageph` and `sexp` into `age` and `sex`. We aslo renamed `chargtot` into `amount`. We will also delete colums which are not important for our analysis rightnow. 
```{r, echo=F}
mtpl <- mtpl_orig %>%
  # rename all columns 
  rename_all(function(.name) {
    .name %>% 
      # replace all names with the lowercase versions
      tolower 
    })
mtpl <- rename(mtpl, age= ageph, sex = sexp, nclaims = nbrtotc, expo = duree,
               amount = chargtot)
kable(head(mtpl))
```

# 2 Empirical analysis
For the begining of our empirical analysis, we will calculate the empirical claim frequency. Empirical claim frequency rate is the anticipated percentage of insured that will make claims against insurance and the number of claims they will make during a certain period. SO we calculate it as 
$$emperical\ claim\ frequency = \frac{\sum{number\ of\ claims}}{\sum{exposure}}$$

```{r, echo=F}
mean(mtpl$nclaims)
sum(mtpl$nclaims)/sum(mtpl$expo)
mtpl %>% summarize(emp_freq = sum(nclaims) / sum(expo)) 
```
We can see that aour empirical claim frequency is low, so we will not expect a large number of claims.

To have a better understanding of our data we can make a graphic presentation of our data.
One column in our data represents the number of claims for every individual in our portfolio. This is a very important information for building our model. We can observe that in majority of the cases we have zero claims per policy. We can also compute the mean and variance that will confirm that.

```{r, echo = F, warning=FALSE}
mean1 <- mean(mtpl$nclaims)
var1 <-  sum((mtpl$nclaims - mean1)^2) /length(mtpl$nclaims)
c(mean = mean1, variance = var1)

```
We see that mean is really close to zero. But to convince you even more, that the majority of the policies have zero claims, we can show you in a graph. Graph below actually shows us that almost 150,000 of policies have zero claims and the number of policies that have more than zero claims is verry low.
```{r, echo=F}
graph1<- ggplot(mtpl, aes(nclaims)) + geom_bar(col = "red", 
              fill = "red", alpha = 0.5) + 
     labs(y = "Abs frequency (in exposure)") +
     ggtitle("MTPL - number of claims")
graph1
```

Looking at this in relative terms, we can see that more than around 90% of insurance contract did not have any claims. So approximatelly 10 % of all policyholders have one or more claims.

```{r, echo=F}
graph2 <- ggplot(mtpl, aes(nclaims)) + theme_bw()
graph2 + geom_bar(aes(y = (..count..)/sum(..count..)), 
    col = "red", fill = "red", alpha = 0.5) + 
  labs(y = "Relative frequency") +
  ggtitle("MTPL - relative number of claims")
```

But the number of claims is not the only information that we have in our data. We can also graphically show relative frequency of exposure (`expo`). We can calculate empirical claim frequency, per unit of exposure and variance. TLE NE VEM LIH TOČNO KAJ ZDEJ TO POMEN

```{r first-risk-calculations-mtpl-2, echo = F, warning=FALSE}
mean2 <- sum(mtpl$nclaims) / sum(mtpl$expo); 
var2 <- sum((mtpl$nclaims-mean2*mtpl$expo)^2)/sum(mtpl$expo) 
#mean2
c(mean = mean2,   variance = var2)
#mtpl %>% summarize(emp_freq = mean2, variance = var2 )
```

We can also group the claims by the gender. In the result below we see that females are in our case more risky, because they have slightly higher mean empirical frequency.

```{r, echo = F, warning=FALSE, message=FALSE}
freq_by_gen <- mtpl %>%  group_by(sex) %>% summarize(emp_freq = sum(nclaims) / sum(expo))
freq_by_gen
```
We can even show this mean empirical frequency for each gender graphically. 
```{r, echo = F, warning=FALSE, message=FALSE}
#ggplot(freq_by_gen, aes(x=sex, y=emp_freq))+
 # geom_bar(col="red", fill ="red", alpha =0.5) to neki ne dela

```

Now we will graphically show side by side relative frequency for our given data.


```{r, echo=F}
ylab <- "Relative frequency"
ggplot.bar <- function(DT, variable, xlab){
  ggplot(data = DT, aes(as.factor(variable)), environment = environment()) + theme_bw() + 
    geom_bar(aes(y = (..count..)/sum(..count..)), col = "red", fill = "red") + labs(x = xlab, y = ylab)
}
ggplot.hist<- function(DT,variable,xlab,binwidth){
  ggplot(data =DT, aes(variable))+theme_bw()+
    geom_histogram (aes(y =(..count..)/sum(..count..)), binwidth = binwidth, col ="red", fill ="red", alpha = 0.5)+
    labs(x=xlab, y=ylab)
} 

sevirity_plot <- ggplot(data = mtpl, aes(mtpl$amount)) + geom_density(adjust = 3, col = "red", fill = "red") + xlim(0,1e4) + ylab(ylab) + xlab("sevirity") + theme_bw()

grid.arrange(ggplot.bar(mtpl, mtpl$nclaims, "nclaims"),
ggplot.hist(mtpl, mtpl$expo, "expo", NULL),
sevirity_plot,
ggplot.bar(mtpl, mtpl$coverp, "coverage"),
ggplot.bar(mtpl, mtpl$fuelc, "fuel"),
ggplot.bar(mtpl, mtpl$sex, "sex"),
ggplot.bar(mtpl, mtpl$usec, "use"),
ggplot.bar(mtpl, mtpl$fleetc, "fleet"),
ggplot.hist(mtpl, mtpl$age, "age", NULL),
ggplot.bar(mtpl, mtpl$powerc, "power"),
ggplot.bar(mtpl, mtpl$agecar, "car age"),
ggplot.bar(mtpl, mtpl$sportc, "sport car"), ncol =4)
```
Among our data, we have a information about the postal code of Belgium in which the claim happened. We can show this in a map.

```{r, echo = F, warning=FALSE, message=FALSE}

mtpl_pc <- aggregate(mtpl$expo ~ mtpl$codposs, data=mtpl, sum)
names(mtpl_pc)[names(mtpl_pc) == "mtpl$expo"] <- "EXP"
names(mtpl_pc)[names(mtpl_pc) == "mtpl$codposs"] <- "PC"
mtpl_pc$N <- mtpl_pc$EXP
head(mtpl_pc)

library(sf)
library(kableExtra)
library(tmap)
belgium_shape_sf <- st_read('C://Users/manca/Documents/NL/Non-Life-insurance/npc96_region_Project1.shp', quiet = TRUE)
belgium_shape_sf <- st_transform(belgium_shape_sf, "+proj=longlat +datum=WGS84")
class(belgium_shape_sf)
belgium_shape_sf %>% as_tibble() %>% select(-geometry) %>% slice(1:3) %>% kable(format="html")
ggplot(belgium_shape_sf) + geom_sf() + ggtitle("Map of Belgium") + theme_bw()
simple_shp <- st_simplify(belgium_shape_sf, dTolerance = 0.00001)
qtm(simple_shp)

tm_shape(simple_shp) +
  tm_borders(col="red", lwd =0.5) +
  tm_layout(main.title = "Map of Belgium",
            legend.outside = TRUE, frame = FALSE)

post_expo <- mtpl %>% group_by(mtpl$codposs) %>% summarize(num=n(), total_expo = sum(mtpl$expo))
post_expo %>% slice(1:5) %>% kable(format = "html")
names(post_expo)[names(post_expo) == "mtpl$codposs"] <- "PC"

belgium_shape_sf <- left_join(belgium_shape_sf, post_expo, by =c("POSTCODE"="PC"))
belgium_shape_sf$freq <- belgium_shape_sf$total_expo/belgium_shape_sf$Shape_Area
belgium_shape_sf$freq_class <- cut(belgium_shape_sf$freq,
    breaks = quantile(belgium_shape_sf$freq, c(0,0.2,0.8,1), na.rm= TRUE),
    right = FALSE, include.lowest = TRUE,
    labels = c("low", "average", "high"))
ggplot(belgium_shape_sf) +
  geom_sf(aes(fill=freq_class),
          colour = "black", size =0.1)+
  ggtitle("MTPL claim frequency data") +
  labs(fill="Relative\nexposure")+
  scale_fill_brewer(palette="Reds",
                     na.value ="white")+
  theme_bw()
```

# 3.2 The construction of a (technical) tariff structure (Manca)
Firs lets build a Poisson GLM for numberof claims, so we are building frequency model. For frequency fitting is the best to use Poisson distribution or Negative Binomial distribution. We will built a GLM for number of claims as a function of a covariance gender, we will also include the log of exposure as an offset.
```{r, echo=F}
freq_glm_1 <- glm(nclaims ~ sex, offset =log(expo), family =poisson(link = "log"),
                  data = mtpl)

freq_glm_1 %>% broom::tidy()
freq_glm_1 %>% broom::augment(type.predict = "response")

emp_freq_female <- exp(coef(freq_glm_1)[1])
emp_freq_male <- exp(coef(freq_glm_1)[1]+coef(freq_glm_1)[2])
c(emp_freq_female, emp_freq_male)
```
If we now look back at the begining of our report, we analysed empirical frequency grouped by the gender. We can see, that we got the same result for empirical frequency by gender, as we did in the first part of the report. this is because we constructed the GLM with only one covariance (sex).
In RStudio we also have a `predict` function that alows us to use our GLM model on new data frames. We can now dafine two new data frames, one being male drivers with exposure 1 and the other being the female drivers with exposure 1. And we can use `predict` function on these two new data frames
```{r, echo=F}
male_driver <- data.frame(expo = 1, sex = "Male")
female_driver <- data.frame(expo = 1, sex = "Female")
c(predict(freq_glm_1, newdata = male_driver, 
       type = "response"),
predict(freq_glm_1, newdata = female_driver, 
       type = "response"))
```
Now we will build a model for sevirity information. For severity, the best distributions for fitting are Gamma and Log-normal distribution. We will firstly do Gamma GLM. So for sevirity we will analyse variable `amount` in our mtpl data. We will again use only one explenatory variable sex. 
```{r, echo=F}
mtpl$amount[mtpl$amount == 0] <- NA     
sev_glm_1 <- glm(amount ~ sex, family = Gamma(link = "log"), data =mtpl)
sev_glm_1
sev_glm_1 %>% broom::tidy()
sev_glm_1 %>% broom::augment(type.predict = "response")
```
Let's conduct different glms and compare them (dodaj potem še besedilo). To see which variables are significant for our model fitting, we will use a drop-in-deviance test. We need to determin if the drop in deviance is significant, so it is justified to use the added variable. To determin that we need to look at the Chi-square distribution with determined degrees of freedom and for the 0.95 quantile. If our drop in deviance is lower than the corresponding Chi-square value, than we do not reject our H0 (model, where some of the betas are set to zero), so the added variable does not have the significant drop in deviance, so we do not add it to our model. If the drop in deviance is larger than our corresponding Chi-square value, than we reject H0 and the drop in deviance is significant, so we add the variable to our model. Firstly we are just cheking the significance of individual variables, so the degrees of fredom used for our Chi-square value is equal to 1. So our critical value is equal to 3.841459
```{r, echo=F}
g1 <- glm(nclaims ~ 1, offset = log(expo), data = mtpl, family = poisson(link = "log")) 
g2 <- glm(nclaims ~ age, offset = log(expo), data = mtpl, family = poisson(link = "log")) 
g3 <- glm(nclaims ~ sex, offset = log(expo), data = mtpl, family = poisson(link = "log")) 
g4 <- glm(nclaims ~ agecar, offset = log(expo), data = mtpl, family = poisson(link = "log")) 
g5 <- glm(nclaims ~ fuelc, offset = log(expo), data = mtpl, family = poisson(link = "log")) 
g6 <- glm(nclaims ~ split, offset = log(expo), data = mtpl, family = poisson(link = "log"))
g7 <- glm(nclaims ~ usec, offset = log(expo), data = mtpl, family = poisson(link = "log")) 
g8 <- glm(nclaims ~ fleetc, offset = log(expo), data = mtpl, family = poisson(link = "log")) 
g9 <- glm(nclaims ~ sportc, offset = log(expo), data = mtpl, family = poisson(link = "log")) 
g10 <- glm(nclaims ~ coverp, offset = log(expo), data = mtpl, family = poisson(link = "log")) 
g11 <- glm(nclaims ~ powerc, offset = log(expo), data = mtpl, family = poisson(link = "log")) 
g12 <- glm(nclaims ~ codposs, offset = log(expo), data = mtpl, family = poisson(link = "log")) 
g1211 <- glm(nclaims ~ codposs + powerc, offset = log(expo), data = mtpl, family = poisson(link = "log")) 
anova(g1, g2, test = "Chisq")
anova(g1, g3, test = "Chisq")
anova(g1, g4, test = "Chisq")
anova(g1, g5, test = "Chisq")
anova(g1, g6, test = "Chisq")
anova(g1, g7, test = "Chisq")
anova(g1, g8, test = "Chisq")
anova(g1, g9, test = "Chisq")
anova(g1, g10, test = "Chisq")
anova(g1, g11, test = "Chisq")
anova(g1, g12,g1211, test = "Chisq")
qchisq(0.95, 1)

```
We see, that the variable with non significant drop in deviance is usec. Now, we can do additional models with two variables.


model z age: sex vn, age:sex vn, usec vn, sportc vn, powerc:age vn, age:codposs vn

```{r, echo=F}
#out
g23 <- glm(nclaims ~ sex + age, offset = log(expo), data = mtpl, family = poisson(link = "log")) 
g23_2 <- glm(nclaims ~ sex + age + age:sex, offset = log(expo), data = mtpl, family = poisson(link = "log")) 
anova(g1, g3, g23, g23_2, test = "Chisq")

g24 <- glm(nclaims ~ age + agecar, offset = log(expo), data = mtpl, family = poisson(link = "log")) 
g24_2 <- glm(nclaims ~ age + agecar + agecar:age, offset = log(expo), data = mtpl, family = poisson(link = "log"))
anova(g1, g2, g24, g24_2, test = "Chisq")

g25 <- glm(nclaims ~ age + fuelc, offset = log(expo), data = mtpl, family = poisson(link = "log")) 
g25_2 <- glm(nclaims ~ age + fuelc + fuelc:age, offset = log(expo), data = mtpl, family = poisson(link = "log"))
anova(g1, g2, g25, g25_2, test = "Chisq")

g26 <- glm(nclaims ~ age + split, offset = log(expo), data = mtpl, family = poisson(link = "log")) 
g26_2 <- glm(nclaims ~ age + split + split:age, offset = log(expo), data = mtpl, family = poisson(link = "log"))
anova(g1, g2, g26, g26_2, test = "Chisq")

#out
g27 <- glm(nclaims ~ age + usec, offset = log(expo), data = mtpl, family = poisson(link = "log")) 
g27_2 <- glm(nclaims ~ age + usec + usec:age, offset = log(expo), data = mtpl, family = poisson(link = "log"))
anova(g1, g2, g27, g27_2, test = "Chisq")

g28 <- glm(nclaims ~ age + fleetc, offset = log(expo), data = mtpl, family = poisson(link = "log")) 
g28_2 <- glm(nclaims ~ age + fleetc + fleetc:age, offset = log(expo), data = mtpl, family = poisson(link = "log"))
anova(g1, g2, g28, g28_2, test = "Chisq")

#out
g29 <- glm(nclaims ~ age + sportc, offset = log(expo), data = mtpl, family = poisson(link = "log")) 
g29_2 <- glm(nclaims ~ age + sportc + sportc:age, offset = log(expo), data = mtpl, family = poisson(link = "log"))
anova(g1, g2, g29, g29_2, test = "Chisq")

g210 <- glm(nclaims ~ age + coverp, offset = log(expo), data = mtpl, family = poisson(link = "log")) 
g210_2 <- glm(nclaims ~ age + coverp + coverp:age, offset = log(expo), data = mtpl, family = poisson(link = "log"))
anova(g1, g2, g210, g210_2, test = "Chisq")

g211 <- glm(nclaims ~ age + powerc, offset = log(expo), data = mtpl, family = poisson(link = "log")) 
#out
g211_2 <- glm(nclaims ~ age + powerc + powerc:age, offset = log(expo), data = mtpl, family = poisson(link = "log"))
anova(g1, g2, g211, g211_2, test = "Chisq")

g212 <- glm(nclaims ~ age + codposs, offset = log(expo), data = mtpl, family = poisson(link = "log")) 
#out
g212_2 <- glm(nclaims ~ age + codposs + codposs:age, offset = log(expo), data = mtpl, family = poisson(link = "log"))
anova(g1, g2, g212, g212_2, test = "Chisq")

g24_2 <- glm(nclaims ~ age + agecar + agecar:age, offset = log(expo), data = mtpl, family = poisson(link = "log"))
g245 <- glm(nclaims ~ age + agecar + agecar:age + fuelc + fuelc:age + fuelc:agecar + age:agecar:fuelc, offset = log(expo), data = mtpl, family = poisson(link = "log"))
anova(g1, g2, g24, g24_2, g245, test = "Chisq")

g245 <- glm(nclaims ~ age + agecar + agecar:age + fuelc + fuelc:age + fuelc:agecar + age:agecar:fuelc, offset = log(expo), data = mtpl, family = poisson(link = "log"))
g2456_8 <- glm(nclaims ~ age + agecar + agecar:age + fuelc + fuelc:age + fuelc:agecar + age:agecar:fuelc +split, offset = log(expo), data = mtpl, family = poisson(link = "log"))
g2456_7 <- glm(nclaims ~ age + agecar + agecar:age + fuelc + fuelc:age + fuelc:agecar + age:agecar:fuelc +split + split:age, offset = log(expo), data = mtpl, family = poisson(link = "log"))
g2456_6 <- glm(nclaims ~ age + agecar + agecar:age + fuelc + fuelc:age + fuelc:agecar + age:agecar:fuelc +split + split:age +split:agecar, offset = log(expo), data = mtpl, family = poisson(link = "log"))
g2456_5 <- glm(nclaims ~ age + agecar + agecar:age + fuelc + fuelc:age + fuelc:agecar + age:agecar:fuelc +split + split:age +split:agecar + split:fuelc, offset = log(expo), data = mtpl, family = poisson(link = "log"))
g2456_4 <- glm(nclaims ~ age + agecar + agecar:age + fuelc + fuelc:age + fuelc:agecar + age:agecar:fuelc +split + split:age +split:agecar + split:fuelc + split:age:agecar, offset = log(expo), data = mtpl, family = poisson(link = "log"))
g2456_3 <- glm(nclaims ~ age + agecar + agecar:age + fuelc + fuelc:age + fuelc:agecar + age:agecar:fuelc +split + split:age +split:agecar + split:fuelc + split:age:agecar + split:age:fuelc, offset = log(expo), data = mtpl, family = poisson(link = "log"))
g2456_2 <- glm(nclaims ~ age + agecar + agecar:age + fuelc + fuelc:age + fuelc:agecar + age:agecar:fuelc +split + split:age +split:agecar + split:fuelc + split:age:agecar + split:age:fuelc + split:agecar:fuelc, offset = log(expo), data = mtpl, family = poisson(link = "log"))
g2456_1 <- glm(nclaims ~ age + agecar + agecar:age + fuelc + fuelc:age + fuelc:agecar + age:agecar:fuelc +split + split:age +split:agecar + split:fuelc + split:age:agecar + split:age:fuelc + split:agecar:fuelc + split:age:agecar:fuelc, offset = log(expo), data = mtpl, family = poisson(link = "log"))
anova(g245,g2456_8, g2456_7,g2456_6,g2456_5, g2456_4, g2456_3, g2456_2, g2456_1, test = "Chisq")
#iz vsega tega smo ugotovili, da je za enkrat optimalni model g2456_7 -> od sedaj naprej gradimo na temu

g2456_7 <- glm(nclaims ~ age + agecar + agecar:age + fuelc + fuelc:age + fuelc:agecar + age:agecar:fuelc +split + split:age, offset = log(expo), data = mtpl, family = poisson(link = "log"))
g24568_1 <- glm(nclaims ~ age + agecar + agecar:age + fuelc + fuelc:age + fuelc:agecar + age:agecar:fuelc +split + split:age+ fleetc, offset = log(expo), data = mtpl, family = poisson(link = "log"))
g24568_2 <- glm(nclaims ~ age + agecar + agecar:age + fuelc + fuelc:age + fuelc:agecar + age:agecar:fuelc +split + split:age+ fleetc + fleetc:age, offset = log(expo), data = mtpl, family = poisson(link = "log"))
g24568_3 <- glm(nclaims ~ age + agecar + agecar:age + fuelc + split +fuelc:age + fuelc:agecar + age:agecar:fuelc  + split:age+ fleetc + fleetc:age + fleetc:split, offset = log(expo), data = mtpl, family = poisson(link = "log"))
g24568_4 <- glm(nclaims ~ age + agecar + agecar:age + fuelc + split +fuelc:age + fuelc:agecar + age:agecar:fuelc  + split:age+ fleetc + fleetc:age + fleetc:split, offset = log(expo), data = mtpl, family = poisson(link = "log"))
anova(g1,g2,g245, g2456_7, g24568_1,g24568_2, g24568_3, g24568_4 )

#iz vsega tega smo ugotovili, da je za enkrat optimalni model g24568_4 -> od sedaj naprej gradimo na temu
g24568_4 <- glm(nclaims ~ age + agecar + agecar:age + fuelc + split +fuelc:age + fuelc:agecar + age:agecar:fuelc  + split:age+ fleetc + fleetc:age + fleetc:split, offset = log(expo), data = mtpl, family = poisson(link = "log"))
g2456810_1 <- glm(nclaims ~ age + agecar + agecar:age + fuelc + split +fuelc:age + fuelc:agecar + age:agecar:fuelc  + split:age+ fleetc + fleetc:age + fleetc:split + coverp, offset = log(expo), data = mtpl, family = poisson(link = "log"))
g2456810_2 <- glm(nclaims ~ age + agecar + agecar:age + fuelc + split +fuelc:age + fuelc:agecar + age:agecar:fuelc  + split:age+ fleetc + fleetc:age + fleetc:split + coverp + coverp:agecar, offset = log(expo), data = mtpl, family = poisson(link = "log"))
g2456810_3 <- glm(nclaims ~ age + agecar + agecar:age + fuelc + split +fuelc:age + fuelc:agecar + age:agecar:fuelc  + split:age+ fleetc + fleetc:age + fleetc:split + coverp + coverp:agecar + coverp:split, offset = log(expo), data = mtpl, family = poisson(link = "log"))
g2456810_4 <- glm(nclaims ~ age + agecar + agecar:age + fuelc + split +fuelc:age + fuelc:agecar + age:agecar:fuelc  + split:age+ fleetc + fleetc:age + fleetc:split + coverp + coverp:agecar + coverp:split + coverp:age:agecar, offset = log(expo), data = mtpl, family = poisson(link = "log"))
anova(g1,g2,g245, g2456_7, g24568_4, g2456810_1, g2456810_2, g2456810_3, g2456810_4)
```




Now lets try some other model than GLM. We can model frequency and sevirity also with GAM.
```{r, echo=F}
library(mgcv)
freq_gam_1 <- gam(nclaims ~ s(age, bs ="cr"),
                  method = "REML",
                  family = poisson(link = "log"), 
                  data =mtpl)
freq_gam_1

freq_glm_age<- glm(nclaims ~ age, offset = log(expo), data = mtpl, family = poisson(link = "log")) 
a <- min(mtpl$age):max(mtpl$age)
pred_glm_age <- predict(freq_glm_age,
                        newdata = data.frame(age = a, expo =1), 
                        type = "terms", se.fit = TRUE)
pred_glm_age
```

# 3.2 The construction of a (technical) tariff structure (Klemen)
```{r, echo=F}

mtpl %>% group_by(age) %>% 
  summarize(emp_freq = sum(nclaims) / sum(expo)) %>% 
  ggplot(aes(x = age, y = emp_freq)) + theme_bw() +
  geom_point(color = "#003366") 

glm.freq1 <- glm(nclaims ~ fuelc, offset = log(expo), data = mtpl, family = poisson(link = "log"))
summary(glm.freq1)

gam.freq1 <- gam(nclaims ~ fuelc, offset = log(expo), data = mtpl, family = poisson(link = "log"))
summary(gam.freq1)

gam.freq2 <- gam(nclaims ~ s(age), offset = log(expo), data = mtpl, family = poisson(link = "log"))
summary(gam.freq2)

pred <- predict(gam.freq2, type = "terms", se = TRUE)
str(pred)

b <- pred$fit[,1]
l <- pred$fit[,1] - qnorm(0.975) * pred$se.fit[,1]
u <- pred$fit[,1] + qnorm(0.975) * pred$se.fit[,1]
x <- mtpl$age
df <- unique(data.frame(x, b, l, u))
df


p <- ggplot(df, aes(x = x))
p <- p + geom_line(aes(y = b), size = 1, col="#003366")
p <- p + geom_line(aes(y = l), size = 0.5, linetype = 2, col="#99CCFF")
p <- p + geom_line(aes(y = u), size = 0.5, linetype = 2, col="#99CCFF")
p <- p + xlab("age") + ylab(expression(hat(f)(age))) + theme_bw()
p

ggplot.gam <- function(model,variable,gam_term,xlabel,ylabel){
  pred <- predict(model, type = "terms", se = TRUE)
  col_index <- which(colnames(pred$fit)==gam_term)
  x <- variable
  b <- pred$fit[, col_index]
  l <- pred$fit[, col_index] - qnorm(0.975) * pred$se.fit[, col_index]
  u <- pred$fit[, col_index] + qnorm(0.975) * pred$se.fit[, col_index]
  df <- unique(data.frame(x, b, l, u))
  p <- ggplot(df, aes(x = x))
  p <- p + geom_line(aes(y = b), size = 1,col="#003366")
  p <- p + geom_line(aes(y = l), size = 0.5, linetype = 2,col="#99CCFF")
  p <- p + geom_line(aes(y = u), size = 0.5, linetype = 2,col="#99CCFF")
  p <- p + xlab(xlabel) + ylab(ylabel) + theme_bw()
  p
}

plot.gam.freq.age <- ggplot.gam(gam.freq2, mtpl$age, "s(age)", "age", expression(hat(f)(age)))
plot.gam.freq.age


```

