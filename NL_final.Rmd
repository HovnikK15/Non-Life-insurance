---
title: "Non-Life Insurance - Final project"
output: html_document
author: "Klemen Hovnik and Manca Strgar"
---

```{r setup, include=FALSE, warning=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r packages,  include=FALSE, warning = FALSE, message = FALSE}
#package instalation:
packages <- c("tidyverse", "mgcv", "evtree", "classInt", "rgdal", "RColorBrewer", "grid", "gridExtra", "visreg", "sf", "tmap", "rgeos", "mapview", "leaflet", "rmarkdown", "ggplot2", "kableExtra")
suppressMessages(packages <- lapply(packages, FUN = function(x) {
  if (!require(x, character.only = TRUE)) {
    install.packages(x)
    library(x, character.only = TRUE)
  }
  else {
  message("Everything is set up correctly. You are ready to go.")
}
}))

#libraries:
library(dplyr)
library(knitr)
library(rmarkdown)
library(tidyverse)
library(ggplot2)
library(graphics)
library(here)
library(gridExtra)
library(mgcv)
library(evtree)
library(classInt)
library(rgdal)
library(RColorBrewer)
library(grid)
library(visreg)
library(sf)
library(tmap)
library(rgeos)
library(mapview)
library(leaflet)
library(kableExtra)


```
PART 1
=======

# 1 Importing dataset

First, we need to import data from the file `Assignment.csv` into R. The file contains 163.657 rows with 16 variables. The column `nbrtotc` shows total number of claims during the period of exposure. 
Let's have a look at our dataset:

```{r, echo=F}
mtpl_orig <- read.csv("Assignment.csv", header = TRUE)
mtpl_orig=as_tibble(mtpl_orig)
kable(head(mtpl_orig))
#str(mtpl_orig)
#summary(mtpl_orig)

```

We could rename colums in our dataset to make it easier to work with. We will rename the column `nbrtotc` into `nclaims` as the number of claims, and `duree` into `expo` as exposure. For easier programming we will also rename `ageph` and `sexp` into `age` and `sex`. We aslo renamed `chargtot` into `amount`. We will also delete colums which are not important for our analysis rightnow. 
```{r, echo=F}
mtpl <- mtpl_orig %>%
  # rename all columns 
  rename_all(function(.name) {
    .name %>% 
      # replace all names with the lowercase versions
      tolower 
    })
mtpl <- rename(mtpl, age= ageph, sex = sexp, nclaims = nbrtotc, expo = duree,
               amount = chargtot)
mtpl$amount[mtpl$amount == 0] <- NA 
kable(head(mtpl))
```

# 2 Empirical analysis
For the begining of our empirical analysis, we will calculate the empirical claim frequency. Empirical claim frequency rate is the anticipated percentage of insured that will make claims against insurance and the number of claims they will make during a certain period. SO we calculate it as 
$$emperical\ claim\ frequency = \frac{\sum{number\ of\ claims}}{\sum{exposure}}$$

```{r, echo=F}
mean(mtpl$nclaims)
sum(mtpl$nclaims)/sum(mtpl$expo)
mtpl %>% summarize(emp_freq = sum(nclaims) / sum(expo)) 
```
We can see that aour empirical claim frequency is low, so we will not expect a large number of claims.

To have a better understanding of our data we can make a graphic presentation of our data.
One column in our data represents the number of claims for every individual in our portfolio. This is a very important information for building our model. We can observe that in majority of the cases we have zero claims per policy. We can also compute the mean and variance that will confirm that.

```{r, echo = F, warning=FALSE}
mean1 <- mean(mtpl$nclaims)
var1 <-  sum((mtpl$nclaims - mean1)^2) /length(mtpl$nclaims)
c(mean = mean1, variance = var1)

```
We see that mean is really close to zero. But to convince you even more, that the majority of the policies have zero claims, we can show you in a graph. Graph below actually shows us that almost 150,000 of policies have zero claims and the number of policies that have more than zero claims is verry low.
```{r, echo=F}
graph1<- ggplot(mtpl, aes(nclaims)) + geom_bar(col = "red", 
              fill = "red", alpha = 0.5) + 
     labs(y = "Abs frequency (in exposure)") +
     ggtitle("MTPL - number of claims")
graph1
```

Looking at this in relative terms, we can see that more than around 90% of insurance contract did not have any claims. So approximatelly 10 % of all policyholders have one or more claims.

```{r, echo=F}
graph2 <- ggplot(mtpl, aes(nclaims)) + theme_bw()
graph2 + geom_bar(aes(y = (..count..)/sum(..count..)), 
    col = "red", fill = "red", alpha = 0.5) + 
  labs(y = "Relative frequency") +
  ggtitle("MTPL - relative number of claims")
```

But the number of claims is not the only information that we have in our data. We can also graphically show relative frequency of exposure (`expo`). We can calculate empirical claim frequency, per unit of exposure and variance. TLE NE VEM LIH TOÄŒNO KAJ ZDEJ TO POMEN

```{r first-risk-calculations-mtpl-2, echo = F, warning=FALSE}
mean2 <- sum(mtpl$nclaims) / sum(mtpl$expo); 
var2 <- sum((mtpl$nclaims-mean2*mtpl$expo)^2)/sum(mtpl$expo) 
#mean2
c(mean = mean2,   variance = var2)
#mtpl %>% summarize(emp_freq = mean2, variance = var2 )
```

We can also group the claims by the gender. In the result below we see that females are in our case more risky, because they have slightly higher mean empirical frequency.

```{r, echo = F, warning=FALSE, message=FALSE}
freq_by_gen <- mtpl %>%  group_by(sex) %>% summarize(emp_freq = sum(nclaims) / sum(expo))
freq_by_gen
```


Now we will graphically show side by side relative frequency for our given data.


```{r, echo=F}
ylab <- "Relative frequency"
ggplot.bar <- function(DT, variable, xlab){
  ggplot(data = DT, aes(as.factor(variable)), environment = environment()) + theme_bw() + 
    geom_bar(aes(y = (..count..)/sum(..count..)), col = "red", fill = "red") + labs(x = xlab, y = ylab)
}
ggplot.hist<- function(DT,variable,xlab,binwidth){
  ggplot(data =DT, aes(variable))+theme_bw()+
    geom_histogram (aes(y =(..count..)/sum(..count..)), binwidth = binwidth, col ="red", fill ="red", alpha = 0.5)+
    labs(x=xlab, y=ylab)
} 

sevirity_plot <- ggplot(data = mtpl, aes(mtpl$amount)) + geom_density(adjust = 3, col = "red", fill = "red") + xlim(0,1e4) + ylab(ylab) + xlab("sevirity") + theme_bw()

grid.arrange(ggplot.bar(mtpl, mtpl$nclaims, "nclaims"),
ggplot.hist(mtpl, mtpl$expo, "expo", NULL),
sevirity_plot,
ggplot.bar(mtpl, mtpl$coverp, "coverage"),
ggplot.bar(mtpl, mtpl$fuelc, "fuel"),
ggplot.bar(mtpl, mtpl$sex, "sex"),
ggplot.bar(mtpl, mtpl$usec, "use"),
ggplot.bar(mtpl, mtpl$fleetc, "fleet"),
ggplot.hist(mtpl, mtpl$age, "age", NULL),
ggplot.bar(mtpl, mtpl$powerc, "power"),
ggplot.bar(mtpl, mtpl$agecar, "car age"),
ggplot.bar(mtpl, mtpl$sportc, "sport car"), ncol =4)
```
Among our data, we have a information about the postal code of Belgium in which the claim happened. We can show this in a map.

```{r, echo = F, warning=FALSE, message=FALSE}

mtpl_pc <- aggregate(mtpl$expo ~ mtpl$codposs, data=mtpl, sum)
names(mtpl_pc)[names(mtpl_pc) == "mtpl$expo"] <- "EXP"
names(mtpl_pc)[names(mtpl_pc) == "mtpl$codposs"] <- "PC"
mtpl_pc$N <- mtpl_pc$EXP
head(mtpl_pc)


belgium_shape_sf <- st_read('npc96_region_Project1.shp', quiet = TRUE)
belgium_shape_sf <- st_transform(belgium_shape_sf, "+proj=longlat +datum=WGS84")
class(belgium_shape_sf)
belgium_shape_sf %>% as_tibble() %>% select(-geometry) %>% slice(1:3) %>% kable(format="html")
ggplot(belgium_shape_sf) + geom_sf() + ggtitle("Map of Belgium") + theme_bw()
simple_shp <- st_simplify(belgium_shape_sf, dTolerance = 0.00001)
qtm(simple_shp)

tm_shape(simple_shp) +
  tm_borders(col="red", lwd =0.5) +
  tm_layout(main.title = "Map of Belgium",
            legend.outside = TRUE, frame = FALSE)

post_expo <- mtpl %>% group_by(mtpl$codposs) %>% summarize(num=n(), total_expo = sum(mtpl$expo))
post_expo %>% slice(1:5) %>% kable(format = "html")
names(post_expo)[names(post_expo) == "mtpl$codposs"] <- "PC"

belgium_shape_sf <- left_join(belgium_shape_sf, post_expo, by =c("POSTCODE"="PC"))
belgium_shape_sf$freq <- belgium_shape_sf$total_expo/belgium_shape_sf$Shape_Area
belgium_shape_sf$freq_class <- cut(belgium_shape_sf$freq,
    breaks = quantile(belgium_shape_sf$freq, c(0,0.2,0.8,1), na.rm= TRUE),
    right = FALSE, include.lowest = TRUE,
    labels = c("low", "average", "high"))
ggplot(belgium_shape_sf) +
  geom_sf(aes(fill=freq_class),
          colour = "black", size =0.1)+
  ggtitle("MTPL claim frequency data") +
  labs(fill="Relative\nexposure")+
  scale_fill_brewer(palette="Reds",
                     na.value ="white")+
  theme_bw()
```

# 3.2 The construction of a (technical) tariff structure (Manca)
Firs lets build a Poisson GLM for numberof claims, so we are building frequency model. For frequency fitting is the best to use Poisson distribution or Negative Binomial distribution. We will built a GLM for number of claims as a function of a covariance gender, we will also include the log of exposure as an offset.
```{r, echo=F}
freq_glm_sex <- glm(nclaims ~ sex, offset =log(expo), family =poisson(link = "log"),
                  data = mtpl)

freq_glm_sex %>% broom::tidy()
freq_glm_sex %>% broom::augment(type.predict = "response")
emp_freq_female <- exp(coef(freq_glm_sex)[1])
emp_freq_male <- exp(coef(freq_glm_sex)[1]+coef(freq_glm_sex)[2])    #TU SEM POPRAVO GLM_1)[1] V GLM_SEX)[1]

c(emp_freq_female, emp_freq_male)
```
If we now look back at the begining of our report, we analysed empirical frequency grouped by the gender. We can see, that we got the same result for empirical frequency by gender, as we did in the first part of the report. this is because we constructed the GLM with only one covariance (sex).
In RStudio we also have a `predict` function that alows us to use our GLM model on new data frames. We can now dafine two new data frames, one being male drivers with exposure 1 and the other being the female drivers with exposure 1. And we can use `predict` function on these two new data frames
```{r, echo=F}
male_driver <- data.frame(expo = 1, sex = "Male")
female_driver <- data.frame(expo = 1, sex = "Female")
c(predict(freq_glm_sex, newdata = male_driver,    #TU SEM POPRAVO _1 V _SEX
       type = "response"),
predict(freq_glm_sex, newdata = female_driver, 
       type = "response"))
```
Now we will build a model for sevirity information. For severity, the best distributions for fitting are Gamma and Log-normal distribution. We will firstly do Gamma GLM. So for sevirity we will analyse variable `amount` in our mtpl data. We will again use only one explenatory variable sex. 
```{r, echo=F}
mtpl$amount[mtpl$amount == 0] <- NA     
sev_glm_1 <- glm(amount ~ sex, offset =log(expo),family = Gamma(link = "log"), data =mtpl)
sev_glm_1
sev_glm_1 %>% broom::tidy()
sev_glm_1 %>% broom::augment(type.predict = "response")
```
Zdej bom nardila neki modelou in potem bom z AIC jim primerjala in videla ker je najboljÅ¡i (opiÅ¡i postopek kako to narediÅ¡)
```{r, echo=F}
freq_glm_1 <- glm(nclaims ~ age + sex + codposs + agecar + fuelc + split + usec + fleetc + sportc + coverp + powerc, offset =log(expo), family =poisson(link = "log"),
                  data = mtpl)
AIC(freq_glm_1) #AIC = 126165.7

freq_glm_2 <- glm(nclaims ~ age + codposs + agecar + fuelc + split + usec + fleetc + sportc + coverp + powerc, offset =log(expo), family =poisson(link = "log"),
                  data = mtpl)
AIC(freq_glm_2) #AIC = 126168.5 model 1 is a better fit

freq_glm_3 <- glm(nclaims ~ age + sex + codposs + agecar + fuelc + split + fleetc + sportc + coverp + powerc, offset =log(expo), family =poisson(link = "log"),
                  data = mtpl)
AIC(freq_glm_3) #AIC = 1126164.5 this model is a better fit

freq_glm_4 <- glm(nclaims ~ age + sex + age:sex + codposs + agecar + fuelc + split + fleetc + sportc + coverp + powerc, offset =log(expo), family =poisson(link = "log"),
                  data = mtpl)
AIC(freq_glm_4) #AIC = 126144.1 this model is a better fit

freq_glm_5<- glm(nclaims ~ age + sex + age:sex + age:powerc + codposs + agecar + fuelc + split + fleetc + sportc + coverp + powerc, offset =log(expo), family =poisson(link = "log"),
                  data = mtpl)
AIC(freq_glm_5) #AIC = 126145.7 model 4 is  a better fit

freq_glm_6 <- glm(nclaims ~ age + sex + age:sex + codposs + agecar + fuelc + split + sportc + coverp + powerc, offset =log(expo), family =poisson(link = "log"),
                  data = mtpl)
AIC(freq_glm_6) #AIC = 126145 model 4 is  a better fit

freq_glm_7 <- glm(nclaims ~ age + sex + age:sex + codposs + agecar + fuelc + split + fleetc + sportc + powerc, offset =log(expo), family =poisson(link = "log"),
                  data = mtpl)
AIC(freq_glm_7) #AIC = 126225.2 model 4 is  a better fit

freq_glm_8 <- glm(nclaims ~ age + sex + age:sex + codposs + agecar + split + fleetc + sportc + coverp + powerc, offset =log(expo), family =poisson(link = "log"),
                  data = mtpl)
AIC(freq_glm_8) #AIC = 126243.5 model 4 is a better fit

freq_glm_9 <- glm(nclaims ~ age + sex + age:sex + codposs + fuelc + split + fleetc + sportc + coverp + powerc, offset =log(expo), family =poisson(link = "log"),
                  data = mtpl)
AIC(freq_glm_9) #AIC = 126196.3 model 4 is a better fit

freq_glm_10 <- glm(nclaims ~ age + sex + age:sex + agecar + fuelc + split + fleetc + sportc + coverp + powerc, offset =log(expo), family =poisson(link = "log"),
                  data = mtpl)
AIC(freq_glm_10) #AIC = 126247.4 model 4 is a better fit

freq_glm_11 <- glm(nclaims ~ age + sex + age:sex + codposs + agecar + fuelc + split + fleetc + coverp + powerc, offset =log(expo), family =poisson(link = "log"),
                  data = mtpl)
AIC(freq_glm_11) #AIC = 126143.1 this model is a better fit

freq_glm_12 <- glm(nclaims ~ age + sex + age:sex + codposs + agecar + fuelc + split + fleetc + coverp, offset =log(expo), family =poisson(link = "log"),
                  data = mtpl)
AIC(freq_glm_12) #AIC = 126172.3 model 11 is a better fit

freq_glm_13 <- glm(nclaims ~ age + sex + age:sex, offset =log(expo), family =poisson(link = "log"),
                  data = mtpl)
AIC(freq_glm_13) #AIC =  126873.1 model 11 is a better fit

freq_glm_14 <- glm(nclaims ~ age + sex + age:sex + codposs + agecar + fuelc + fleetc + coverp + powerc, offset =log(expo), family =poisson(link = "log"),
                  data = mtpl)
AIC(freq_glm_14) #AIC = 126494.5 model 11 is a better fit

freq_glm_15 <- glm(nclaims ~ age + sex + age:sex + codposs + agecar + fuelc + agecar:fuelc + split + fleetc + coverp + powerc, offset =log(expo), family =poisson(link = "log"),
                  data = mtpl)
AIC(freq_glm_15) #AIC = 126132.7 this model is a better fit

freq_glm_16 <- glm(nclaims ~ age + sex + age:sex + codposs + agecar + fuelc + agecar:fuelc + split + fleetc + coverp + powerc + sex:powerc, offset =log(expo), family =poisson(link = "log"),
                  data = mtpl)
AIC(freq_glm_16) #AIC = 126131.2 this model is a better fit

freq_glm_17 <- glm(nclaims ~ age + sex  + codposs + agecar + fuelc + agecar:fuelc + split + fleetc + coverp + powerc + age:sex+ sex:powerc + age:codposs, offset =log(expo), family =poisson(link = "log"),
                  data = mtpl)
AIC(freq_glm_17) #AIC = 126132.9 model 16 is a better fit

freq_glm_18 <- glm(nclaims ~ age + sex  + codposs + agecar + fuelc  + split + fleetc + coverp + powerc + age:sex+ agecar:fuelc+ sex:powerc + age:split, offset =log(expo), family =poisson(link = "log"),
                  data = mtpl)
AIC(freq_glm_18) #AIC = 126108.6 this model is a better fit

freq_glm_19 <- glm(nclaims ~ age + sex  + codposs + agecar + fuelc  + split + fleetc + coverp + powerc + age:sex+ agecar:fuelc+ sex:powerc + age:split + age:agecar, offset =log(expo), family =poisson(link = "log"),
                  data = mtpl)
AIC(freq_glm_19) #AIC = 126104.3 this model is a better fit

freq_glm_20 <- glm(nclaims ~ age + sex  + codposs + agecar + fuelc  + split + fleetc + coverp + powerc + age:sex+ agecar:fuelc+ sex:powerc + age:split + age:agecar + fuelc:coverp, offset =log(expo), family =poisson(link = "log"),
                  data = mtpl)
AIC(freq_glm_20) #AIC = 126106 model 18 is a better fit
```
Fitting severity model
```{r, echo=F}
sev_glm_1 <- glm(amount ~ age + sex + codposs + agecar + fuelc + split + usec + fleetc + sportc + coverp + powerc, offset =log(expo), family =Gamma(link = "log"),
                  data = mtpl)
summary(sev_glm_1) #AIC = 307984
sev_glm_2 <- glm(amount ~ age + codposs + agecar + fuelc + split + usec + fleetc + sportc + coverp + powerc, offset =log(expo), family =Gamma(link = "log"),
                  data = mtpl)
summary(sev_glm_2) #AIC = 308017 model 1 is a better fit
sev_glm_3 <- glm(amount ~ age + sex + codposs + agecar + fuelc + split + fleetc + sportc + coverp + powerc, offset =log(expo), family =Gamma(link = "log"),
                  data = mtpl)
summary(sev_glm_3) #AIC = 307984 this model is a better fit
sev_glm_4 <- glm(amount ~ age + sex + age:sex + codposs + agecar + fuelc + split + fleetc + sportc + coverp + powerc, offset =log(expo), family =Gamma(link = "log"),
                  data = mtpl)
summary(sev_glm_4) #AIC = 307978 this model is a better fit
sev_glm_5 <- glm(amount ~ age + sex + age:sex + codposs + agecar + fuelc + split + sportc + coverp + powerc, offset =log(expo), family =Gamma(link = "log"),
                  data = mtpl)
summary(sev_glm_5) #AIC = 307990 model 4 is  a better fit
sev_glm_6 <- glm(amount ~ age + sex + age:sex + codposs + agecar + fuelc + split + fleetc + sportc + powerc, offset =log(expo), family =Gamma(link = "log"),
                  data = mtpl)
summary(sev_glm_6) #AIC = 308133 model 4 is  a better fit
sev_glm_7 <- glm(amount ~ age + sex + age:sex + codposs + agecar + split + fleetc + sportc + coverp + powerc, offset =log(expo), family =Gamma(link = "log"),
                  data = mtpl)
summary(sev_glm_7) #AIC = 308004 model 4 is a better fit
sev_glm_8 <- glm(amount ~ age + sex + age:sex + codposs + fuelc + split + fleetc + sportc + coverp + powerc, offset =log(expo), family =Gamma(link = "log"),
                  data = mtpl)
summary(sev_glm_8) #AIC = 308091 model 4 is a better fit
sev_glm_9 <- glm(amount ~ age + sex + age:sex + agecar + fuelc + split + fleetc + sportc + coverp + powerc, offset =log(expo), family =Gamma(link = "log"),
                  data = mtpl)
summary(sev_glm_9) #AIC = 307978 this model is a better fit
######sev_glm_11 <- glm(amount ~ age + sex + age:sex + codposs + agecar + fuelc + split + fleetc + coverp + powerc, offset =log(expo), family =poisson(link = "log"),data = mtpl)
summary(freq_glm_11) #AIC = 126143 this model is a better fit
sev_glm_12 <- glm(amount ~ age + sex + age:sex + codposs + agecar + fuelc + split + fleetc + coverp, offset =log(expo), family =poisson(link = "log"),
                  data = mtpl)
summary(freq_glm_12) #AIC = 126172 model 11 is a better fit
sev_glm_13 <- glm(amount ~ age + sex + age:sex, offset =log(expo), family =poisson(link = "log"),
                  data = mtpl)
summary(freq_glm_12) #AIC =  126873 model 11 is a better fit
sev_glm_13 <- glm(amount ~ age + sex + age:sex + codposs + agecar + fuelc + fleetc + coverp + powerc, offset =log(expo), family =poisson(link = "log"),
                  data = mtpl)
summary(freq_glm_13) #AIC = 126494 model 11 is a better fit
sev_glm_14 <- glm(amount ~ age + sex + age:sex + codposs + agecar + fuelc + agecar:fuelc + split + fleetc + coverp + powerc, offset =log(expo), family =poisson(link = "log"),
                  data = mtpl)
summary(freq_glm_14) #AIC = 126133 this model is a better fit
sev_glm_15 <- glm(amount ~ age + sex + age:sex + codposs + agecar + fuelc + agecar:fuelc + split + fleetc + coverp + powerc + sex:powerc, offset =log(expo), family =poisson(link = "log"),
                  data = mtpl)
summary(freq_glm_15) #AIC = 126131 this model is a better fit
sev_glm_16 <- glm(amount ~ age + sex  + codposs + agecar + fuelc + agecar:fuelc + split + fleetc + coverp + powerc + age:sex+ sex:powerc + age:codposs, offset =log(expo), family =poisson(link = "log"),
                  data = mtpl)
summary(freq_glm_16) #AIC = 126133 model 15 is a better fit
sev_glm_17 <- glm(amount ~ age + sex  + codposs + agecar + fuelc  + split + fleetc + coverp + powerc + age:sex+ agecar:fuelc+ sex:powerc + age:split, offset =log(expo), family =poisson(link = "log"),
                  data = mtpl)
summary(freq_glm_17) #AIC = 126109 this model is a better fit
sev_glm_18 <- glm(amount ~ age + sex  + codposs + agecar + fuelc  + split + fleetc + coverp + powerc + age:sex+ agecar:fuelc+ sex:powerc + age:split + age:agecar, offset =log(expo), family =poisson(link = "log"),
                  data = mtpl)
summary(freq_glm_18) #AIC = 126104 this model is a better fit
sev_glm_19 <- glm(amount ~ age + sex  + codposs + agecar + fuelc  + split + fleetc + coverp + powerc + age:sex+ agecar:fuelc+ sex:powerc + age:split + age:agecar + fuelc:coverp, offset =log(expo), family =poisson(link = "log"),
                  data = mtpl)
summary(freq_glm_19) #AIC = 126106 model 18 is a better fit
sev_glm_20 <- glm(amount ~ age + sex  + codposs + agecar + fuelc  + split + fleetc + coverp + powerc + age:sex+ agecar:fuelc+ sex:powerc + age:split + age:agecar+ codposs:powerc, offset =log(expo), family =poisson(link = "log"),
                  data = mtpl)
summary(freq_glm_20) #AIC = 126106 model 18 is a better fit
```



```{r, echo=F}

```
Final model, that is the best fit for frequency mofrling is the following model
```{r, echo=F}

```

Now lets try some other model than GLM. We can model frequency and sevirity also with GAM.
```{r, echo=F}
library(mgcv)
freq_gam_1 <- gam(nclaims ~ s(age, bs ="cr"),
                  method = "REML",
                  family = poisson(link = "log"), 
                  data =mtpl)
freq_gam_1

freq_glm_age<- glm(nclaims ~ age, offset = log(expo), data = mtpl, family = poisson(link = "log")) 
a <- min(mtpl$age):max(mtpl$age)
pred_glm_age <- predict(freq_glm_age,
                        newdata = data.frame(age = a, expo =1), 
                        type = "terms", se.fit = TRUE)
pred_glm_age
```

# 3.2 The construction of a (technical) tariff structure (Klemen)
```{r, echo=F}

mtpl %>% group_by(age) %>% 
  summarize(emp_freq = sum(nclaims) / sum(expo)) %>% 
  ggplot(aes(x = age, y = emp_freq)) + theme_bw() +
  geom_point(color = "#003366") 

glm.freq1 <- glm(nclaims ~ fuelc, offset = log(expo), data = mtpl, family = poisson(link = "log"))
summary(glm.freq1)

gam.freq1 <- gam(nclaims ~ fuelc, offset = log(expo), data = mtpl, family = poisson(link = "log"))
summary(gam.freq1)

gam.freq2 <- gam(nclaims ~ s(age), offset = log(expo), data = mtpl, family = poisson(link = "log"))
summary(gam.freq2)

pred <- predict(gam.freq2, type = "terms", se = TRUE)
str(pred)

b <- pred$fit[,1]
l <- pred$fit[,1] - qnorm(0.975) * pred$se.fit[,1]
u <- pred$fit[,1] + qnorm(0.975) * pred$se.fit[,1]
x <- mtpl$age
df <- unique(data.frame(x, b, l, u))
df


p <- ggplot(df, aes(x = x))
p <- p + geom_line(aes(y = b), size = 1, col="#003366")
p <- p + geom_line(aes(y = l), size = 0.5, linetype = 2, col="#99CCFF")
p <- p + geom_line(aes(y = u), size = 0.5, linetype = 2, col="#99CCFF")
p <- p + xlab("age") + ylab(expression(hat(f)(age))) + theme_bw()
p

ggplot.gam <- function(model,variable,gam_term,xlabel,ylabel){
  pred <- predict(model, type = "terms", se = TRUE)
  col_index <- which(colnames(pred$fit)==gam_term)
  x <- variable
  b <- pred$fit[, col_index]
  l <- pred$fit[, col_index] - qnorm(0.975) * pred$se.fit[, col_index]
  u <- pred$fit[, col_index] + qnorm(0.975) * pred$se.fit[, col_index]
  df <- unique(data.frame(x, b, l, u))
  p <- ggplot(df, aes(x = x))
  p <- p + geom_line(aes(y = b), size = 1,col="#003366")
  p <- p + geom_line(aes(y = l), size = 0.5, linetype = 2,col="#99CCFF")
  p <- p + geom_line(aes(y = u), size = 0.5, linetype = 2,col="#99CCFF")
  p <- p + xlab(xlabel) + ylab(ylabel) + theme_bw()
  p
}

plot.gam.freq.age <- ggplot.gam(gam.freq2, mtpl$age, "s(age)", "age", expression(hat(f)(age)))
plot.gam.freq.age


```

###Model GAM

```{r, echo=f}
#freq_gam <- gam(nclaims  ~  
#                  coverage + fuelc + 
#                  s(age) + s(bm) + 
#                  s(powerc) + s(long, lat) +
#                  ti(ageph, power, bs = "tp"), 
#                offset = log(expo), 
#                data = mtpl, 
#                family = poisson(link = "log"))

```

