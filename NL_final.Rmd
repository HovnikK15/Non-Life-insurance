---
title: "Non-Life Insurance - Final project"
output: html_document
author: "Klemen Hovnik and Manca Strgar"
---

```{r setup, include=FALSE, warning=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r packages,  include=FALSE, warning = FALSE, message = FALSE}
#package instalation:
packages <- c("tidyverse", "mgcv", "evtree", "classInt", "rgdal", "RColorBrewer", "grid", "gridExtra", "visreg", "sf", "tmap", "rgeos", "mapview", "leaflet", "rmarkdown", "ggplot2")
suppressMessages(packages <- lapply(packages, FUN = function(x) {
  if (!require(x, character.only = TRUE)) {
    install.packages(x)
    library(x, character.only = TRUE)
  }
  else {
  message("Everything is set up correctly. You are ready to go.")
}
}))

#libraries:
library(dplyr)
library(knitr)
library(rmarkdown)
library(tidyverse)
library(ggplot2)
library(graphics)
library(here)
library(gridExtra)
library(mgcv)
library(evtree)
library(classInt)
library(rgdal)
library(RColorBrewer)
library(grid)
library(visreg)
library(sf)
library(tmap)
library(rgeos)
library(mapview)
library(leaflet)

```
PART 1
=======

# 1 Importing dataset

First, we need to import data from the file `Assignment.csv` into R. The file contains 163.657 rows with 16 variables. The column `nbrtotc` shows total number of claims during the period of exposure. 
Let's have a look at our dataset:

```{r, echo=F}
mtpl_orig <- read.csv("Assignment.csv", header = TRUE)
mtpl_orig=as_tibble(mtpl_orig)
kable(head(mtpl_orig))
#str(mtpl_orig)
#summary(mtpl_orig)

```

We could rename colums in our dataset to make it easier to work with. We will rename the column `Clm_Count` into `nclaims` as the number of claims, and `TLength` into `expo` as exposure. For easier programming we will also rename `AgeInsued` and `SexInsured` into `age` and `sex`. We will also delete colums which are not important for our analysis rightnow. 
```{r, echo=F}
mtpl <- mtpl_orig %>%
  # rename all columns 
  rename_all(function(.name) {
    .name %>% 
      # replace all names with the lowercase versions
      tolower 
    })
mtpl <- rename(mtpl, nclaims = nbrtotc, expo = duree,
               claims = chargtot)
kable(head(mtpl))
```

# 2 Empirical analysis

To have a better understanding of our data we can make a graph with number of claims per insurance contract. We can observe that in the majority of cases there is zero claims per contract.

```{r, echo=F}
mean(mtpl$nclaims)
sum(mtpl$nclaims)/sum(mtpl$expo)
mtpl %>% summarize(emp_freq = sum(nclaims) / sum(expo)) 
```
Continuing our analysis, we can compute the mean and variance of the number of observed claims. 

```{r, echo = F, warning=FALSE}
mean1 <- mean(mtpl$nclaims)
var1 <-  sum((mtpl$nclaims - mean1)^2) /length(mtpl$nclaims)
c(mean = mean1, variance = var1)

```

```{r, echo=F}
graph1<- ggplot(mtpl, aes(nclaims)) + geom_bar(col = "red", 
              fill = "red", alpha = 0.5) + 
     labs(y = "Abs frequency (in exposure)") +
     ggtitle("MTPL - number of claims")
graph1
```

Looking at this in relative terms, we can see that more than 90% of insurance contract did not have any claims. 

```{r, echo=F}
graph2 <- ggplot(mtpl, aes(nclaims)) + theme_bw()
graph2 + geom_bar(aes(y = (..count..)/sum(..count..)), 
    col = "red", fill = "red", alpha = 0.5) + 
  labs(y = "Relative frequency") +
  ggtitle("MTPL - relative number of claims")
```





Because we have different exposures between policyholders, we could take exposure information `expo` into account as well. Then we can calculate empirical claim frequency, per unit of exposure and variance. 

```{r first-risk-calculations-mtpl-2, echo = F, warning=FALSE}
mean2 <- sum(mtpl$nclaims) / sum(mtpl$expo); 
var2 <- sum((mtpl$nclaims-mean2*mtpl$expo)^2)/sum(mtpl$expo) 
#mean2
c(mean = mean2,   variance = var2)
#mtpl %>% summarize(emp_freq = mean2, variance = var2 )
```

If we do the same for each gender we see that claim frequency is higher for males than females.

```{r, echo = F, warning=FALSE, message=FALSE}
mtpl %>%  group_by(sexp) %>% summarize(emp_freq = sum(nclaims) / sum(expo))

```
```{r, echo=F}
#g <- ggplot(mtpl, aes(bm)) + theme_bw()
#g + geom_histogram(binwidth = 1, col = KULbg, fill = KULbg, alpha = .5)
```

# 3 The construction of a (technical) tariff structure
```{r, echo=F}

mtpl %>% group_by(ageph) %>% 
  summarize(emp_freq = sum(nclaims) / sum(expo)) %>% 
  ggplot(aes(x = ageph, y = emp_freq)) + theme_bw() +
  geom_point(color = "#003366")

glm.freq1 <- glm(nclaims ~ fuelc, offset = log(expo), data = mtpl, family = poisson(link = "log"))
summary(glm.freq1)

gam.freq1 <- gam(nclaims ~ fuelc, offset = log(expo), data = mtpl, family = poisson(link = "log"))
summary(gam.freq1)

gam.freq2 <- gam(nclaims ~ s(ageph), offset = log(expo), data = mtpl, family = poisson(link = "log"))
summary(gam.freq2)

pred <- predict(gam.freq2, type = "terms", se = TRUE)
str(pred)

b <- pred$fit[,1]
l <- pred$fit[,1] - qnorm(0.975) * pred$se.fit[,1]
u <- pred$fit[,1] + qnorm(0.975) * pred$se.fit[,1]
x <- mtpl$ageph
df <- unique(data.frame(x, b, l, u))
df


p <- ggplot(df, aes(x = x))
p <- p + geom_line(aes(y = b), size = 1, col="#003366")
p <- p + geom_line(aes(y = l), size = 0.5, linetype = 2, col="#99CCFF")
p <- p + geom_line(aes(y = u), size = 0.5, linetype = 2, col="#99CCFF")
p <- p + xlab("ageph") + ylab(expression(hat(f)(ageph))) + theme_bw()
p

ggplot.gam <- function(model,variable,gam_term,xlabel,ylabel){
  pred <- predict(model, type = "terms", se = TRUE)
  col_index <- which(colnames(pred$fit)==gam_term)
  x <- variable
  b <- pred$fit[, col_index]
  l <- pred$fit[, col_index] - qnorm(0.975) * pred$se.fit[, col_index]
  u <- pred$fit[, col_index] + qnorm(0.975) * pred$se.fit[, col_index]
  df <- unique(data.frame(x, b, l, u))
  p <- ggplot(df, aes(x = x))
  p <- p + geom_line(aes(y = b), size = 1,col="#003366")
  p <- p + geom_line(aes(y = l), size = 0.5, linetype = 2,col="#99CCFF")
  p <- p + geom_line(aes(y = u), size = 0.5, linetype = 2,col="#99CCFF")
  p <- p + xlab(xlabel) + ylab(ylabel) + theme_bw()
  p
}

plot.gam.freq.ageph <- ggplot.gam(gam.freq2, mtpl$ageph, "s(ageph)", "ageph", expression(hat(f)(ageph)))
plot.gam.freq.ageph


```

